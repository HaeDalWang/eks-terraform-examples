version: 0.2

env:
  variables:
    CHART_REPO_NAME: ezl-helm-chart
    SECRET_NAME: ezl-mgm

phases:
  pre_build:
    commands:
      - REPO_NAME=$(basename $FULL_REPOSITORY_NAME)
      - COMMIT_HASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)
      - AWS_ACCOUNT_ID=$(echo $CODEBUILD_BUILD_ARN | cut -f5 -d ':')
      - echo Logging in to Amazon ECR...
      - |
        aws ecr get-login-password \
        --region $AWS_DEFAULT_REGION | \
        docker login --username AWS --password-stdin \
        $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
      # ìºì‹± í™œìš©ì„ ìœ„í•´ ì§€ì • í•„ìš”
      - export DOCKER_BUILDKIT=1
      # ìºì‹±ì— ì“°ì¼ ì´ë¯¸ì§€ pull, í•´ë‹¹ íƒœê·¸ì˜ ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ê·¸ëŒ€ë¡œ ì§„í–‰
      - docker pull $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$REPO_NAME:build || true
      # í™˜ê²½ì— ë”°ë¼ì„œ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ íƒœê·¸ì— ì‚¬ìš©í•  ë³€ìˆ˜ ì ìš©
      - | 
        if [ $ENV = "dev" ]; then
          IMAGE_TAG=${COMMIT_HASH:=latest}
        else
          IMAGE_TAG=$TAG_NAME
        fi
  build:
    commands:
      - echo Building the API Docker image...
      # ìºì‹œ ì´ë¯¸ì§€ ìƒì„± (ìºì‹± ì ìš©)
      - |
        docker build --platform linux/amd64 \
        --target build \
        --cache-from $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$REPO_NAME:build \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --build-arg IMAGE_TAG=$IMAGE_TAG \
        --tag $REPO_NAME:build .
      - |
        docker tag \
        $REPO_NAME:build \
        $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$REPO_NAME:build
      # ìµœì¢… ì´ë¯¸ì§€ ìƒì„± (ìºì‹± ì ìš©)
      - |   
        docker build --platform linux/amd64 \
        --cache-from $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$REPO_NAME:build \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --build-arg IMAGE_TAG=$IMAGE_TAG \
        --tag $REPO_NAME:$IMAGE_TAG .
      - |
        docker tag \
        $REPO_NAME:$IMAGE_TAG \
        $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$REPO_NAME:$IMAGE_TAG
  post_build:
    commands:
      - echo Build completed on `date`

      # ë¹Œë“œ ê²°ê³¼ ë©”ì‹œì§€ ì‘ì„±
      - echo create build message...
      - |
        if [ $CODEBUILD_BUILD_SUCCEEDING -eq 1 ]; then
          export BUILD_STATUS="succeeded â˜€ï¸"
        else
          export BUILD_STATUS="failed ğŸŒ§ï¸"
        fi
      - export SLACK_MESSAGE="Build $BUILD_STATUS for project $REPO_NAME, tag $IMAGE_TAG, build number $CODEBUILD_BUILD_NUMBER"
      - echo $SLACK_MESSAGE
      # ë„ì»¤ ì´ë¯¸ì§€ Push
      - |
        echo Pushing the Docker image...
        docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$REPO_NAME:build
        docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$REPO_NAME:$IMAGE_TAG
      # ìŠ¬ë™ ì›¹í›… í˜¸ì¶œ
      - echo send build message to slack...
      - |
        curl -X POST -H 'Content-type: application/json' --data "{'text':'$SLACK_MESSAGE'}" $SLACK_WEBHOOK_URL

      # Helm ì°¨íŠ¸ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
      - |
        if [ $ENV = "dev" ]; then
          CODEPIPELINE_NAME=$(basename $CODEBUILD_INITIATOR)
          COMMIT_MESSAGE=$(aws codepipeline list-pipeline-executions --pipeline-name $CODEPIPELINE_NAME --max-items 1 --query 'pipelineExecutionSummaries[0].sourceRevisions[0].revisionSummary' | jq -r '. | fromjson | .CommitMessage')
          GITHUB_TOKEN=$(aws secretsmanager get-secret-value --secret-id $SECRET_NAME --query 'SecretString' | jq -r | jq -r '.github.token')
          git clone https://$GITHUB_TOKEN@github.com/ezllabs/$CHART_REPO_NAME.git
          cd $CHART_REPO_NAME/$REPO_NAME
          wget https://github.com/mikefarah/yq/releases/download/v4.44.2/yq_linux_amd64 -O /usr/bin/yq
          chmod +x /usr/bin/yq
          yq -i '.global.image.tag=strenv(IMAGE_TAG)' values_$ENV.yaml
          git config --global user.email $AUTHOR_EMAIL
          git config --global user.name $AUTHOR_ID
          git add .
      
          if ! git diff-index --quiet HEAD; then
            git commit -m "$COMMIT_MESSAGE"
            git push origin  
          fi
        fi
