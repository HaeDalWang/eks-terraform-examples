# n8n Helm Chart Values (community-charts/n8n v1.16.15)
# ref: https://artifacthub.io/packages/helm/community-charts/n8n

# ========================================
# n8n 이미지 설정
# ========================================
image:
  # repository: n8nio/n8n
  repository: svvwac98/n8n-ffmpeg
  tag: "latest"
  pullPolicy: Always

# serviceAccount:
#   create: true

# ========================================
# 암호화 키 (필수)
# ========================================
encryptionKey: "${n8n_encryption_key}"

# ========================================
# 타임존 설정
# ========================================
timezone: "Asia/Seoul"

# ========================================
# Ingress 설정 (ingress-nginx 사용)
# ========================================
ingress:
  enabled: true
  className: "nginx"
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
  hosts:
    - host: n8n.${domain}
      paths:
        - path: /
          pathType: Prefix
  tls: []

# ========================================
# Service 설정
# ========================================
service:
  enabled: true
  type: ClusterIP
  port: 5678

# ========================================
# Database 설정 (PostgreSQL 사용)
# ========================================
db:
  type: postgresdb
  postgresdb:
    poolSize: 2
    connectionTimeout: 20000
    schema: public
    ssl:
      enabled: false

# ========================================
# 내장 PostgreSQL (Bitnami subchart)
# ========================================
postgresql:
  enabled: true
  auth:
    username: n8n
    password: "${postgresql_password}"
    database: n8n
  primary:
    persistence:
      enabled: true
      storageClass: gp3
      size: 20Gi

# ========================================
# Main Pod 설정
# ========================================
main:
  # Editor base URL (NLB에서 TLS 터미네이션하므로 HTTPS로 명시 설정)
  editorBaseUrl: "https://n8n.${domain}"

  # 리소스 설정
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 2Gi

  # Persistence 설정
  persistence:
    enabled: true
    storageClass: gp3
    accessMode: ReadWriteOnce
    size: 10Gi

  # 추가 환경 변수
  # n8n 2.0에서는 executeCommand가 기본적으로 비활성화되어 있음
  # NODES_EXCLUDE를 빈 배열로 설정하여 모든 노드 활성화 (또는 특정 노드만 제외)
  extraEnvVars:
    NODES_EXCLUDE: "[]"
    # 바이너리 파일 저장 시 모든 경로 허용 원래는 안되는데 버그 때문에 그냥 다 허용
    N8N_RESTRICT_FILE_ACCESS_TO: ""
    # .n8n 디렉토리와 사용자 정의 구성 파일에 대한 모든 파일 접근을 허용
    N8N_BLOCK_FILE_ACCESS_TO_N8N_FILES: "false"
    # 노드 내부에서 환경 변수 접근을 허용
    N8N_BLOCK_ENV_ACCESS_IN_NODES: "true"

# ========================================
# Pod Security Context
# ========================================
podSecurityContext:
  fsGroup: 1000
  fsGroupChangePolicy: "OnRootMismatch"

securityContext:
  allowPrivilegeEscalation: false
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000

# ========================================
# 외부 Redis 설정 (Queue mode 필요시)
# 현재는 비활성화 - 필요시 설정
# ========================================
externalRedis:
  host: ""
  # password: ""
  # port: 6379

# ========================================
# 로그 설정
# ========================================
log:
  level: info
  output:
    - console

# ========================================
# API 설정
# ========================================
api:
  enabled: true
  path: api
  swagger:
    enabled: true

# ========================================
# 버전 알림 비활성화
# ========================================
versionNotifications:
  enabled: false

# ========================================
# 진단 비활성화
# ========================================
diagnostics:
  enabled: false

# ========================================
# 커뮤니티 노드 설치
# ========================================
nodes:
  external:
    allowAll: false
    packages:
      - "n8n-nodes-mediafx@1.5.0"